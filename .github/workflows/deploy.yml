name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            cd /home/ubuntu/vkusvill-mcp-bot
            
            echo "üì• Pulling latest code..."
            git pull origin main
            
            echo "üõë Stopping containers..."
            docker compose down
            
            echo "üîß Setting git info for container..."
            export GIT_COMMIT_HASH=$(git rev-parse --short HEAD)
            export GIT_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M')
            export GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            
            echo "üî® Building and starting containers..."
            docker compose up -d --build
            
            echo "‚è≥ Waiting for bot to start..."
            sleep 10
            
            echo "üîç Checking container status..."
            if ! docker compose ps | grep -q "vkusvill-bot.*Up"; then
              echo "‚ùå Bot container is not running!"
              docker compose logs --tail=50 vkusvill-bot
              exit 1
            fi
            
            echo "‚úÖ Deployment completed successfully!"
            docker compose ps
      
      - name: Notify on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è!
            
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
